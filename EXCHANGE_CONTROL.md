# –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ë–∏—Ä–∂–∞–º–∏ - Exchange Control

## –û–ø–∏—Å–∞–Ω–∏–µ

–î–æ–±–∞–≤–ª–µ–Ω–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≤–∫–ª—é—á–µ–Ω–∏—è/–æ—Ç–∫–ª—é—á–µ–Ω–∏—è —Å–∏–≥–Ω–∞–ª–æ–≤ —Å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö –±–∏—Ä–∂ —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è.

## –ù–æ–≤—ã–µ –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (.env)

```bash
# Exchange Control
BINANCE_ENABLED=true    # –í–∫–ª—é—á–∏—Ç—å/–æ—Ç–∫–ª—é—á–∏—Ç—å —Å–∏–≥–Ω–∞–ª—ã Binance
BYBIT_ENABLED=true      # –í–∫–ª—é—á–∏—Ç—å/–æ—Ç–∫–ª—é—á–∏—Ç—å —Å–∏–≥–Ω–∞–ª—ã Bybit
```

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### 1. –û–±–µ –±–∏—Ä–∂–∏ –≤–∫–ª—é—á–µ–Ω—ã (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
```bash
BINANCE_ENABLED=true
BYBIT_ENABLED=true
```
–°–µ—Ä–≤–µ—Ä –ø–æ–ª—É—á–∞–µ—Ç —Å–∏–≥–Ω–∞–ª—ã –æ—Ç –æ–±–µ–∏—Ö –±–∏—Ä–∂ (—Ç–µ–∫—É—â–µ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ).

### 2. –¢–æ–ª—å–∫–æ Binance
```bash
BINANCE_ENABLED=true
BYBIT_ENABLED=false
```
–°–µ—Ä–≤–µ—Ä —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç —Å–∏–≥–Ω–∞–ª—ã, –ø–æ–∫–∞–∑—ã–≤–∞—è —Ç–æ–ª—å–∫–æ Binance (exchange_id=1).

### 3. –¢–æ–ª—å–∫–æ Bybit
```bash
BINANCE_ENABLED=false
BYBIT_ENABLED=true
```
–°–µ—Ä–≤–µ—Ä —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç —Å–∏–≥–Ω–∞–ª—ã, –ø–æ–∫–∞–∑—ã–≤–∞—è —Ç–æ–ª—å–∫–æ Bybit (exchange_id=2).

### 4. –û–±–µ –æ—Ç–∫–ª—é—á–µ–Ω—ã (–û–®–ò–ë–ö–ê)
```bash
BINANCE_ENABLED=false
BYBIT_ENABLED=false
```
‚ö†Ô∏è –°–µ—Ä–≤–µ—Ä –ù–ï –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è —Å –æ—à–∏–±–∫–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–∏:
```
ValueError: At least one exchange must be enabled (BINANCE_ENABLED or BYBIT_ENABLED)
```

## –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Å–µ—Ä–≤–µ—Ä –ø–æ–∫–∞–∂–µ—Ç —Å—Ç–∞—Ç—É—Å –±–∏—Ä–∂:

```
Signal WebSocket Server initialized on 0.0.0.0:8765
Hybrid mode: NOTIFY=enabled, Lightweight check interval=1s
Enabled exchanges: Binance=enabled, Bybit=disabled
```

–ü—Ä–∏ broadcast —Å–∏–≥–Ω–∞–ª–æ–≤:
```
üì° Broadcast 5 signals to 2 clients (Binance: 5, Bybit: 0)
```

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –î–µ—Ç–∞–ª–∏

### –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –°–µ—Ä–≤–µ—Ä–µ (signal_websocket_server.py)

1. **–ù–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏** (—Å—Ç—Ä–æ–∫–∞ 65-67):
   ```python
   self.binance_enabled = config.get('BINANCE_ENABLED', 'true').lower() == 'true'
   self.bybit_enabled = config.get('BYBIT_ENABLED', 'true').lower() == 'true'
   ```

2. **–í–∞–ª–∏–¥–∞—Ü–∏—è** (—Å—Ç—Ä–æ–∫–∞ 97-99):
   ```python
   if not self.binance_enabled and not self.bybit_enabled:
       raise ValueError("At least one exchange must be enabled...")
   ```

3. **–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π SQL –∑–∞–ø—Ä–æ—Å** (–º–µ—Ç–æ–¥ `build_signal_query()`):
   - –§–æ—Ä–º–∏—Ä—É–µ—Ç —Å–ø–∏—Å–æ–∫ –≤–∫–ª—é—á–µ–Ω–Ω—ã—Ö exchange_id
   - –î–æ–±–∞–≤–ª—è–µ—Ç —Ñ–∏–ª—å—Ç—Ä `WHERE tp.exchange_id IN (1, 2)` –∏–ª–∏ `IN (1)` –∏–ª–∏ `IN (2)`

4. **–£–ª—É—á—à–µ–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**:
   - –ü—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç–∞—Ç—É—Å –±–∏—Ä–∂
   - –ü—Ä–∏ broadcast –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–∏–≥–Ω–∞–ª–æ–≤ –ø–æ –±–∏—Ä–∂–∞–º

### –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –ö–ª–∏–µ–Ω—Ç–µ (signal_websocket_client.py)

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω –±–∞–≥ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏** (—Å—Ç—Ä–æ–∫–∞ 422):
```python
# –ë—ã–ª–æ:
if self.allowed_exchanges and signal.get('exchange') not in self.allowed_exchanges:

# –°—Ç–∞–ª–æ:
if self.allowed_exchanges and str(signal.get('exchange_id')) not in self.allowed_exchanges:
```

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

1. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: –û—Ç–∫–ª—é—á–µ–Ω–Ω–∞—è –±–∏—Ä–∂–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏—Å–∫–ª—é—á–∞–µ—Ç—Å—è –∏–∑ SQL –∑–∞–ø—Ä–æ—Å–∞
2. **–ì–∏–±–∫–æ—Å—Ç—å**: –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ .env –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–¥–∞
3. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**: –í–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç —Å–ª—É—á–∞–π–Ω–æ–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ –≤—Å–µ—Ö –±–∏—Ä–∂
4. **–°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å**: –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –æ–±–µ –±–∏—Ä–∂–∏ –≤–∫–ª—é—á–µ–Ω—ã (–æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å)
5. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**: –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –±–∏—Ä–∂

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç 1: –û–±–µ –±–∏—Ä–∂–∏ –≤–∫–ª—é—á–µ–Ω—ã
```bash
# –í .env
BINANCE_ENABLED=true
BYBIT_ENABLED=true

# –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
python3 signal_websocket_server.py
# –î–æ–ª–∂–Ω—ã –±—ã—Ç—å —Å–∏–≥–Ω–∞–ª—ã –æ—Ç –æ–±–µ–∏—Ö –±–∏—Ä–∂
```

### –¢–µ—Å—Ç 2: –¢–æ–ª—å–∫–æ Binance
```bash
# –í .env
BINANCE_ENABLED=true
BYBIT_ENABLED=false

# –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
# –¢–æ–ª—å–∫–æ —Å–∏–≥–Ω–∞–ª—ã —Å exchange_id=1
# –õ–æ–≥–∏: "Binance=enabled, Bybit=disabled"
```

### –¢–µ—Å—Ç 3: –¢–æ–ª—å–∫–æ Bybit
```bash
# –í .env
BINANCE_ENABLED=false
BYBIT_ENABLED=true

# –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
# –¢–æ–ª—å–∫–æ —Å–∏–≥–Ω–∞–ª—ã —Å exchange_id=2
# –õ–æ–≥–∏: "Binance=disabled, Bybit=enabled"
```

### –¢–µ—Å—Ç 4: –û–±–µ –æ—Ç–∫–ª—é—á–µ–Ω—ã (–¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—à–∏–±–∫–∞)
```bash
# –í .env
BINANCE_ENABLED=false
BYBIT_ENABLED=false

# –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
# ValueError –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
```

## –û—Ç–∫–∞—Ç –ò–∑–º–µ–Ω–µ–Ω–∏–π

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Å—Ç–∞—Ä–æ–π –≤–µ—Ä—Å–∏–∏:

1. –£–¥–∞–ª–∏—Ç—å —Å—Ç—Ä–æ–∫–∏ –∏–∑ .env:
   ```bash
   BINANCE_ENABLED=true
   BYBIT_ENABLED=true
   ```

2. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ –±—ç–∫–∞–ø–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å):
   ```bash
   cp signal_websocket_server.py.backup signal_websocket_server.py
   ```

–ë–µ–∑ —ç—Ç–∏—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –≤ .env —Å–µ—Ä–≤–µ—Ä –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–æ–±–µ –±–∏—Ä–∂–∏ –≤–∫–ª—é—á–µ–Ω—ã).

## –î–∞—Ç–∞ –†–µ–∞–ª–∏–∑–∞—Ü–∏–∏

2025-11-07 - –í–∞—Ä–∏–∞–Ω—Ç A (—Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ WHERE IN)
